<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iFindCar – חיפוש וסינון רכבים</title>
  <style>
    :root{--bg:#0b0c10;--card:#15171d;--ink:#e9eef5;--muted:#a8b3c7;--accent:#5ab0ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,12,16,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #202430}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    h1{margin:0 0 6px;font-size:20px}
    .filters{display:grid;gap:10px;grid-template-columns:repeat(6,minmax(0,1fr))}
    .filters>*{grid-column:span 6}
    @media (min-width:700px){.filters .col-2{grid-column:span 2}.filters .col-3{grid-column:span 3}.filters .col-6{grid-column:span 6}}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:var(--ink);outline:none}
    input::placeholder{color:#7f8aa3}
    button{background:var(--accent);color:#001629;font-weight:700;border:none;cursor:pointer}
    button.ghost{background:#0f1218;color:var(--muted);border:1px solid #2a2f3a}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:6px 10px;background:#0f1218;border:1px solid #2a2f3a;border-radius:999px;font-size:13px;display:inline-flex;gap:6px;align-items:center}
    .chip button{all:unset;cursor:pointer;color:#93a0b6}
    .results{padding:18px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media (min-width:700px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (min-width:1000px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid #222836;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .title{font-weight:700;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .equip{display:flex;flex-wrap:wrap;gap:6px}
    .equip span{background:#0f1218;border:1px solid #2a2f3a;border-radius:8px;padding:4px 8px;font-size:12px;color:#cfe1ff}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:8px;color:var(--muted);font-size:14px}
    .pill{background:#0f1218;border:1px solid #2a2f3a;border-radius:999px;padding:6px 10px;font-size:12px}
    a.src{color:#7cc2ff;text-decoration:none}
    footer{color:#73809b;padding:18px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>iFindCar – חיפוש וסינון</h1>
      <div class="filters">
        <input id="q" class="col-3" placeholder="חיפוש חופשי (דגם/גרסה/מנוע/אבזור)" />
        <input id="minPrice" class="col-1" type="number" inputmode="numeric" placeholder="מחיר מינ׳" />
        <input id="maxPrice" class="col-1" type="number" inputmode="numeric" placeholder="מחיר מקס׳" />
        <input id="equipInput" class="col-3" placeholder="הוסף איבזור לסינון (Enter)" />
        <div id="equipChips" class="chips col-6" aria-live="polite"></div>
        <select id="sort" class="col-2">
          <option value="relevance">מיון: רלוונטיות</option>
          <option value="priceAsc">מחיר ↑</option>
          <option value="priceDesc">מחיר ↓</option>
          <option value="title">שם דגם</option>
        </select>
        <div class="col-2" style="display:flex;gap:8px">
          <button id="apply">סנן</button>
          <button id="clear" class="ghost">ניקוי</button>
        </div>
        <div class="col-2 pill" id="meta">טוען…</div>
      </div>
    </div>
  </header>

  <section class="results wrap">
    <div class="grid" id="grid"></div>
  </section>

  <footer>
    נטען מ-cars.json. נתוני הדגמה מסקרייפר.
  </footer>

<script>
const state = { raw: [], cars: [], equipments: new Set(), updated: null };

const els = {
  grid: document.getElementById('grid'),
  q: document.getElementById('q'),
  minPrice: document.getElementById('minPrice'),
  maxPrice: document.getElementById('maxPrice'),
  equipInput: document.getElementById('equipInput'),
  equipChips: document.getElementById('equipChips'),
  sort: document.getElementById('sort'),
  meta: document.getElementById('meta'),
  apply: document.getElementById('apply'),
  clear: document.getElementById('clear'),
};

async function loadData(){
  try{
    const res = await fetch('./cars.json', {cache:'no-store'});
    const data = await res.json();
    state.updated = data.updated || null;
    state.raw = Array.isArray(data) ? data : (data.cars || data.results || []);
    normalize();
    render();
  }catch(e){
    els.meta.textContent = 'שגיאת טעינה: ' + e.message;
  }
}

const getFirst = (obj, keys) => { for (const k of keys) if (obj && obj[k] != null) return obj[k]; };
const toNumber = v => {
  if (v == null) return null;
  if (typeof v === 'number') return v;
  const s = String(v).replace(/[^\d.,]/g,'').replace(/,/g,'');
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
};
function normalize(){
  state.cars = state.raw.map((c,i)=>{
    const title = getFirst(c, ['title','version','model','name','דגם','כותרת']) || `דגם #${i+1}`;
    const price = toNumber(getFirst(c, ['price_nis','price','מחיר','מחיר_ש״ח','מחיר_שח']));
    let equipment = getFirst(c, ['equipment','אבזור']);
    if (!Array.isArray(equipment)) equipment = [];
    let specs = getFirst(c, ['specs','מפרט','spec','details']);
    if (!specs || typeof specs !== 'object') specs = {};
    if (Object.keys(specs).length === 0) {
      const skip = new Set(['title','version','model','name','דגם','כותרת','price_nis','price','מחיר','equipment','אבזור','source','url']);
      for (const k of Object.keys(c||{})) {
        if (!skip.has(k) && typeof c[k] !== 'object') specs[k] = c[k];
      }
    }
    const src = getFirst(c, ['source','url','link','קישור']);
    return { id:i, title, price, equipment, specs, src, raw:c };
  });
}

function applyFilters(){
  const q = els.q.value.trim().toLowerCase();
  const minP = Number(els.minPrice.value || 0);
  const maxP = Number(els.maxPrice.value || Infinity);
  const needles = Array.from(state.equipments);

  let list = state.cars.filter(c=>{
    const inPrice = (c.price ?? Infinity) >= minP && (c.price ?? 0) <= maxP;
    const text = [c.title, JSON.stringify(c.specs), (c.equipment||[]).join(' ')].join(' ').toLowerCase();
    const inText = !q || text.includes(q);
    const hasAllEquip = needles.every(n =>
      (c.equipment||[]).some(x => (x||'').toLowerCase().includes(n.toLowerCase()))
    );
    return inPrice && inText && hasAllEquip;
  });

  const sort = els.sort.value;
  if(sort === 'priceAsc') list.sort((a,b)=>(a.price??Infinity)-(b.price??Infinity));
  else if(sort === 'priceDesc') list.sort((a,b)=>(b.price??-Infinity)-(a.price??-Infinity));
  else if(sort === 'title') list.sort((a,b)=>a.title.localeCompare(b.title,'he'));

  return list;
}

function render(){
  const list = applyFilters();
  const upd = state.updated ? ` • עודכן: ${new Date(state.updated).toLocaleString('he-IL')}` : '';
  els.meta.textContent = `נמצאו ${list.length} דגמים (מתוך ${state.cars.length})${upd}`;
  els.grid.innerHTML = list.map(cardHTML).join('') || `<div class="muted">לא נמצאו תוצאות</div>`;
}

function cardHTML(c){
  const price = (c.price!=null) ? c.price.toLocaleString('he-IL') + ' ₪' : '—';
  const equip = (c.equipment||[]).slice(0,10).map(e=>`<span>${escapeHtml(e)}</span>`).join('') || '<span>—</span>';
  const specPairs = Object.entries(c.specs||{}).slice(0,6).map(([k,v])=>`
      <div><span class="muted">${escapeHtml(k)}:</span> ${escapeHtml(v)}</div>
  ).join('') || '<div class="muted">—</div>';
  const src = c.src ? `<a class="src" href="${c.src}" target="_blank" rel="noopener">למקור</a>` : '';
  return `
    <article class="card">
      <div class="title">${escapeHtml(c.title)}</div>
      <div class="muted">מחיר: <b>${price}</b></div>
      <div class="equip">${equip}</div>
      <div class="muted">מפרט:</div>
      <div>${specPairs}</div>
      <div class="toolbar">
        <span class="muted">${Object.keys(c.specs||{}).length} מאפייני מפרט</span>
        ${src}
      </div>
    </article>
  `;
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

const drawEquipChips = ()=> els.equipChips.innerHTML = Array.from(state.equipments).map(t=>`
  <span class="chip">${escapeHtml(t)} <button type="button" data-tag="${escapeHtml(t)}">✕</button></span>
`).join('');
function addEquipTag(t){ t=t.trim(); if(!t) return; state.equipments.add(t); els.equipInput.value=''; drawEquipChips(); render(); }
els.equipChips.addEventListener('click',e=>{ const t=e.target?.dataset?.tag; if(t){ state.equipments.delete(t); drawEquipChips(); render(); }});

els.apply.addEventListener('click', render);
els.clear.addEventListener('click', ()=>{ els.q.value=''; els.minPrice.value=''; els.maxPrice.value=''; state.equipments.clear(); drawEquipChips(); els.sort.value='relevance'; render(); });
els.equipInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addEquipTag(els.equipInput.value) } });

loadData();
</script>
</body>
  </html> 
