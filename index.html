<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>iFindCar — סינון</title>
<style>
:root{--bg:#0b0c10;--ink:#e9eef5;--muted:#9fb0cc;--card:#15171d;--line:#212734;--accent:#5ab0ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit}
h1{margin:0 0 6px 0;font-size:22px}
small.m{color:var(--muted)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.panel{background:#0f1218;border:1px solid var(--line);border-radius:14px;padding:14px}
.grid{display:grid;gap:12px}
.grid2{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
.grid3{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
input,select,button{border:1px solid var(--line);background:#0b0f15;color:var(--ink);border-radius:10px;padding:10px 12px}
input[type=number]{appearance:textfield}
input[type=range]{width:100%}
label{font-weight:600;font-size:13px;margin-bottom:6px;display:block}
.row{display:grid;gap:6px}
.box{border:1px solid var(--line);background:#0b0f15;border-radius:12px;padding:10px}
.tri{display:flex;gap:8px}
.tri label{font-weight:400}
.btn{background:var(--accent);color:#06223d;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.ghost{background:#0b0f15;color:var(--muted);border:1px solid var(--line)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{border:1px solid var(--line);background:#0b0f15;border-radius:999px;padding:4px 8px;font-size:12px;color:#cfe1ff}
.resultBar{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
.list{display:grid;gap:12px;margin-top:12px}
.item{display:flex;gap:12px;padding:10px}
.pic{width:140px;aspect-ratio:16/10;background:#0f1218;flex:0 0 auto;display:flex;align-items:center;justify-content:center}
.pic img{width:100%;height:100%;object-fit:cover}
.meta{font-size:13px;color:var(--muted)}
.hide{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <h1>מסך סינון — iFindCar</h1>
    <small class="m">כל הערכים נבנים אוטומטית מתוך <code>cars.json</code>.</small>

    <div class="panel grid" id="filterPanel">
      <!-- בחירת יצרן/דגם -->
      <div class="grid2">
        <div class="row">
          <label for="makeSel">יצרן</label>
          <select id="makeSel"></select>
        </div>
        <div class="row">
          <label for="modelSel">דגם</label>
          <select id="modelSel" disabled></select>
        </div>
      </div>

      <!-- טווחים כמותיים כלליים -->
      <div class="grid3" id="numericGeneral">
        <!-- נבנה דינמית: מחיר, שנה, מנוע (אם מספרי) -->
      </div>

      <!-- טווחי specs -->
      <div>
        <label>מימדים / מפרט</label>
        <div class="grid3" id="numericSpecs">
          <!-- נבנה דינמית: length/width/height/wheelbase/trunk/powerHP ... -->
        </div>
      </div>

      <!-- איבזור בוליאני -->
      <div>
        <label>איבזור</label>
        <div class="grid3" id="featureBooleans"></div>
      </div>

      <div class="controls">
        <button id="apply" class="btn">החל סינון</button>
        <button id="clear" class="btn ghost">ניקוי</button>
        <span id="last" class="m"></span>
      </div>
    </div>

    <div class="resultBar">
      <div>
        <b id="count">0</b> תוצאות תואמות
        <span id="chips"></span>
      </div>
      <div>
        <button id="toggleList" class="btn ghost">הצג/הסתר תוצאות</button>
      </div>
    </div>

    <div id="resultList" class="list hide"></div>
  </div>

<script>
const els = {
  makeSel: document.getElementById('makeSel'),
  modelSel: document.getElementById('modelSel'),
  numericGeneral: document.getElementById('numericGeneral'),
  numericSpecs: document.getElementById('numericSpecs'),
  featureBooleans: document.getElementById('featureBooleans'),
  apply: document.getElementById('apply'),
  clear: document.getElementById('clear'),
  last: document.getElementById('last'),
  count: document.getElementById('count'),
  chips: document.getElementById('chips'),
  toggleList: document.getElementById('toggleList'),
  resultList: document.getElementById('resultList'),
};

const FEATURE_LABELS = {
  cruise:'בקרת שיוט',
  rearCamera:'מצלמת רוורס',
  keyless:'כניסה/הנעה ללא מפתח',
  laneAssist:'שמירת נתיב',
  aeb:'בלימה אוטונומית',
};
const TRI = [['','הכל'],['true','כן'],['false','לא']];

const state = {
  raw:[],
  cars:[],
  makeToModels:new Map(),
  numerics:{general:{}, specs:{}}, // {key: {min,max}}
  featureKeys:[],
  filters:{
    make:'', model:'',
    general:{}, specs:{},
    features:{} // key: '','true','false'
  }
};

const esc = s => String(s ?? '').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const num = v => {
  if (v==null) return null;
  if (typeof v==='number') return Number.isFinite(v)?v:null;
  const n = Number(String(v).replace(/[^\d.,-]/g,'').replace(/,/g,''));
  return Number.isFinite(n)?n:null;
};

function getLastScraped(arr){
  let t=0; for(const r of arr){const d=Date.parse(r.scrapedAt||r.updated||''); if(!Number.isNaN(d)) t=Math.max(t,d);}
  return t||null;
}

async function load(){
  const res = await fetch('./cars.json',{cache:'no-store'});
  const data = await res.json();
  state.raw = Array.isArray(data)?data:(data.cars||[]);
  normalize();
  buildMakeModel();
  analyzeNumerics();
  analyzeFeatures();
  renderFilters();
  applyFilters(); // ראשוני
}

function normalize(){
  state.cars = state.raw.map((r,i)=>{
    const make=r.make||'', model=r.model||'', trim=r.trim||'';
    const title=[make,model,trim].filter(Boolean).join(' ')||`דגם #${i+1}`;
    return {
      id:i, title,
      make, model, trim,
      price: num(r.price),
      year: num(r.year),
      engine: num(r.engine),
      image: r.image||'',
      source: r.source||r.url||'',
      features: (r.features && typeof r.features==='object')? r.features : {},
      specs: (r.specs && typeof r.specs==='object')? r.specs : {}
    };
  });
  const t=getLastScraped(state.raw);
  if(t) els.last.textContent='עודכן: '+new Date(t).toLocaleString('he-IL');
}

function buildMakeModel(){
  const map = new Map();
  for(const c of state.cars){
    const m = (map.get(c.make)||new Set());
    if (c.model) m.add(c.model);
    map.set(c.make,m);
  }
  state.makeToModels = map;
}

function analyzeNumerics(){
  const add = (bag,key,val)=>{
    if(val==null) return;
    if(!bag[key]) bag[key]={min:val,max:val};
    else{ bag[key].min=Math.min(bag[key].min,val); bag[key].max=Math.max(bag[key].max,val); }
  };
  const general={}, specs={};
  for(const c of state.cars){
    add(general,'price',c.price);
    add(general,'year',c.year);
    add(general,'engine',c.engine);
    if (c.specs && typeof c.specs==='object'){
      for(const [k,v] of Object.entries(c.specs)){
        const n=num(v); add(specs,k,n);
      }
    }
  }
  // השמט טווחים לא תקפים (null או min==max)
  const prune = obj=>{
    for(const [k,v] of Object.entries(obj)){
      if(v.min==null || v.max==null || v.min===v.max){ delete obj[k]; }
    }
  };
  prune(general); prune(specs);
  state.numerics = {general,specs};
}

function analyzeFeatures(){
  const keys=new Set();
  for(const c of state.cars){
    for(const [k,v] of Object.entries(c.features||{})){
      if (typeof v === 'boolean') keys.add(k);
    }
  }
  state.featureKeys = Array.from(keys);
}

function optionList(opts, sel){
  return opts.map(([v,t])=>`<option value="${esc(v)}"${v===sel?' selected':''}>${esc(t)}</option>`).join('');
}

function renderFilters(){
  // יצרן
  const makeOpts = [['','כל היצרנים'], ...Array.from(state.makeToModels.keys()).filter(Boolean).sort().map(m=>[m,m])];
  els.makeSel.innerHTML = optionList(makeOpts,state.filters.make);
  els.makeSel.onchange = ()=>{
    state.filters.make = els.makeSel.value;
    renderModelSelect();
  };
  // דגם (ראשוני)
  renderModelSelect();

  // כלליים (מחיר/שנה/engine אם קיים)
  els.numericGeneral.innerHTML = '';
  for(const [key,range] of Object.entries(state.numerics.general)){
    els.numericGeneral.insertAdjacentHTML('beforeend', numericBoxHTML('general',key,range));
  }

  // specs
  els.numericSpecs.innerHTML = '';
  for(const [key,range] of Object.entries(state.numerics.specs)){
    els.numericSpecs.insertAdjacentHTML('beforeend', numericBoxHTML('specs',key,range));
  }

  // איבזור
  els.featureBooleans.innerHTML = state.featureKeys.map(k=>{
    const pretty = FEATURE_LABELS[k]||k;
    const name = `feat_${k}`;
    return `
      <div class="box">
        <div class="row">
          <label>${esc(pretty)}</label>
          <div class="tri">
            ${TRI.map(([v,t])=>`
              <label><input type="radio" name="${esc(name)}" value="${esc(v)}"${state.filters.features[k]===v?' checked':''}> ${esc(t)}</label>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderModelSelect(){
  const make = els.makeSel.value;
  const set = state.makeToModels.get(make)||new Set();
  const models = Array.from(set).filter(Boolean).sort();
  const opts = [['','כל הדגמים'], ...models.map(m=>[m,m])];
  els.modelSel.innerHTML = optionList(opts,state.filters.model);
  els.modelSel.disabled = opts.length<=1;
  els.modelSel.onchange = ()=>{ state.filters.model = els.modelSel.value; };
}

function numericBoxHTML(scope,key,range){
  const idMin = `${scope}_${key}_min`, idMax = `${scope}_${key}_max`;
  const label = prettyLabel(key);
  const sel = state.filters[scope]?.[key] || {min:range.min, max:range.max};
  // שמור ערכי ברירת מחדל אם לא קיימים
  state.filters[scope] = state.filters[scope] || {};
  state.filters[scope][key] = {min: sel.min, max: sel.max};

  return `
  <div class="box">
    <label>${esc(label)}</label>
    <div class="grid2">
      <input id="${esc(idMin)}" type="number" inputmode="numeric" placeholder="מינימום" value="${sel.min}">
      <input id="${esc(idMax)}" type="number" inputmode="numeric" placeholder="מקסימום" value="${sel.max}">
    </div>
    <div class="grid2" style="margin-top:6px">
      <input type="range" min="${range.min}" max="${range.max}" value="${sel.min}" step="1" oninput="document.getElementById('${esc(idMin)}').value=this.value">
      <input type="range" min="${range.min}" max="${range.max}" value="${sel.max}" step="1" oninput="document.getElementById('${esc(idMax)}').value=this.value">
    </div>
  </div>`;
}

function prettyLabel(k){
  const map = {
    price:'מחיר (₪)', year:'שנה', engine:'נפח/מנוע',
    length:'אורך (מ״מ)', width:'רוחב (מ״מ)', height:'גובה (מ״מ)',
    wheelbase:'בסיס גלגלים (מ״מ)', trunk:'תא מטען (ל׳)', powerHP:'כ״ס'
  };
  return map[k]||k;
}

function readFilterValues(){
  // יצרן/דגם
  state.filters.make = els.makeSel.value;
  state.filters.model = els.modelSel.value;

  // כלליים
  for(const key of Object.keys(state.numerics.general)){
    const min = Number(document.getElementById(`general_${key}_min`).value);
    const max = Number(document.getElementById(`general_${key}_max`).value);
    state.filters.general[key]={min,max};
  }
  // specs
  for(const key of Object.keys(state.numerics.specs)){
    const min = Number(document.getElementById(`specs_${key}_min`).value);
    const max = Number(document.getElementById(`specs_${key}_max`).value);
    state.filters.specs[key]={min,max};
  }
  // איבזור
  for(const k of state.featureKeys){
    const name=`feat_${k}`;
    const r=[...document.querySelectorAll(`input[name="${CSS.escape(name)}"]`)].find(x=>x.checked);
    state.filters.features[k]= r ? r.value : '';
  }
}

function applyFilters(){
  readFilterValues();

  const chips=[];
  if(state.filters.make) chips.push(state.filters.make);
  if(state.filters.model) chips.push(state.filters.model);

  let list = state.cars.filter(c=>{
    if(state.filters.make && c.make!==state.filters.make) return false;
    if(state.filters.model && c.model!==state.filters.model) return false;

    // כלליים
    for(const [k,{min,max}] of Object.entries(state.filters.general)){
      const v = c[k];
      if(v==null || v<min || v>max) return false;
      if (min) chips.push(`${prettyLabel(k)} ≥ ${min}`);
      if (max) chips.push(`${prettyLabel(k)} ≤ ${max}`);
    }
    // specs
    for(const [k,{min,max}] of Object.entries(state.filters.specs)){
      const v = num(c.specs[k]);
      if(v==null || v<min || v>max) return false;
    }
    // איבזור
    for(const [k,mode] of Object.entries(state.filters.features)){
      if(!mode) continue; // הכל
      const has = !!(c.features && c.features[k]===true);
      if(mode==='true' && !has) return false;
      if(mode==='false' && has) return false;
    }
    return true;
  });

  els.count.textContent = String(list.length);
  els.chips.innerHTML = chips.length ? ' • ' + chips.map(t=>`<span class="chip">${esc(t)}</span>`).join(' ') : '';

  // תצוגה מינימלית (אפשר להסתיר)
  els.resultList.innerHTML = list.map(c=>{
    const price = c.price!=null? (c.price.toLocaleString('he-IL')+' ₪') : '—';
    return `
      <div class="card item">
        <div class="pic">${c.image?`<img src="${esc(c.image)}" alt="">`:'<span class="meta">אין תמונה</span>'}</div>
        <div>
          <div><b>${esc(c.title)}</b></div>
          <div class="meta">
            ${c.year?`שנה ${esc(c.year)} • `:''}
            ${c.engine?`מנוע ${esc(c.engine)} • `:''}
            מחיר: ${price}
            ${c.source?` • <a href="${esc(c.source)}" target="_blank" rel="noopener">מקור</a>`:''}
          </div>
        </div>
      </div>`;
  }).join('');
}

els.apply.onclick = applyFilters;

els.clear.onclick = ()=>{
  state.filters={make:'',model:'',general:{},specs:{},features:{}};
  renderFilters(); applyFilters();
};

els.toggleList.onclick = ()=>{
  els.resultList.classList.toggle('hide');
};

load();
</script>
</body>
</html>
